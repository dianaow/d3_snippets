<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<div id="chart"></div>
<script>

  ///////////////////////////////////////////////////////////////////////////
  ///////////////////////////////// Globals /////////////////////////////////
  /////////////////////////////////////////////////////////////////////////// 
  var data
  var canvasDim = { width: 1500, height: 1200}
  var margin = {top: 30, right: 30, bottom: 20, left: 30}
  var width = canvasDim.width - margin.left - margin.right
  var height = canvasDim.height - margin.top - margin.bottom

  var crime = ["Money Laundering", "Credit card fraud", "Sanctioned transaction", "Ponzi schemes", "Terrorist financing"]
  ///////////////////////////////////////////////////////////////////////////
  //////////////////// Set up and initiate containers ///////////////////////
  /////////////////////////////////////////////////////////////////////////// 

  var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var nodes = svg.append('g')
    .attr('class', 'nodes')

  ///////////////////////////////////////////////////////////////////////////
  ///////////////////////////// Create scales ///////////////////////////////
  ///////////////////////////////////////////////////////////////////////////

  var colorScale = d3.scaleOrdinal()
    .domain(["1", "2", "3", "4", "5", "6", "7", "8"])
    .range(['#f0f0f0','#d9d9d9','#bdbdbd','#969696','#737373','#525252','#252525','#000000'])

  var radiusScale = d3.scaleLinear()
    .domain(d3.range(1,9))
    .range(d3.range(6, 30, 3))

  ///////////////////////////////////////////////////////////////////////////
  ////////////////////////////// Data processing ////////////////////////////
  ///////////////////////////////////////////////////////////////////////////
  for(i=0; i<5; i++) {
    run(i)
  }
  
  function run(iteration) {

    data = d3.range(13).map(function (d,i) {
      return {
          id: i,
          parentId: crime[iteration],
          score: getRndBias(0, 1, 0.5, 1),
          color: colorScale(getRandomArbitrary(1, 8).toString()),
          size: radiusScale(getRandomArbitrary(1, 8))
      }
    })
    data.push({id: crime[iteration], color: "red", score:1})
    vData = d3.stratify()(data);
    drawCirclePack(vData, (iteration+1)*400);
  
  }

  ///////////////////////////////////////////////////////////////////////////
  /////////////////////////// Create circle pack ////////////////////////////
  ///////////////////////////////////////////////////////////////////////////

  function drawCirclePack(vData, w) {

      var vLayout = d3.pack().size([w, height/6]).padding(5)

      // Layout + Data
      var vRoot = d3.hierarchy(vData).sum(function (d) { return d.data.size; });
      var vNodes = vRoot.descendants();

      vLayout(vRoot);
      var groups = nodes.selectAll('.pack'+Math.round(w).toString()).data(vNodes)

      var vSlices = groups.enter().append("g")
        .attr('class', 'pack'+Math.round(w).toString())

      vSlices.append("defs").attr("id", "imgdefs")
          .append("pattern")
            .attr("id", function(d,i) { return "image-" + d.data.id})
            .attr("height", d=>d.r)
            .attr("width", d=>d.r)
          .append('image')
            .attr("xlink:href", function(d,i) {
              let score = (d.height==0 ? d.data.data.score: d.data.score) || 1
              if( d.r >25 ) { 
                if( score > 0.8 ) {
                  return "./icons_svg/user.svg"
                } else if ( score < 0.4 ) {
                  return "./icons_svg/building.svg"
                } else {
                  console.log('hi')
                  return "./icons_svg/handshake.svg"
                }
              }
            })  
            .style('background-color', function(d) { return d.height==0 ? d.data.data.color: "white" })
            .attr("x", d=>d.r/2)
            .attr("y", d=>d.r/2)
            .attr("height", d=>d.r)
            .attr("width", d=>d.r)

      vSlices.append('circle')
          .attr('fill-opacity', 1)
          .attr("fill", function(d) { return d.height==0 ? d.data.data.color: "white"})
          .attr("stroke", function(d) { return d.height==0 ? d.data.data.color: "red"})
          .attr('stroke-width', function(d) { return d.height==0 ? "0px" : "5px"})
          .attr('r', function (d) { return d.r })
          .attr('cx', function (d) { return d.x; })
          .attr('cy', function (d) { return d.y; })

      vSlices.append('circle')
        .attr('fill-opacity', function(d) { return d.height==0 ? 1: 0})
        .attr("fill", function(d) { return "url(#" + ("image-" + d.data.id) + ")" || "none" })
        .attr('r', function (d) { return d.r })
        .attr('cx', function (d) { return d.x; })
        .attr('cy', function (d) { return d.y; })

  }

  ///////////////////////////////////////////////////////////////////////////
  ///////////////////////////// Helper functions ////////////////////////////
  ///////////////////////////////////////////////////////////////////////////
  function getRndBias(min, max, bias, influence) {
    var rnd = Math.random() * (max - min) + min,   // random in range
        mix = Math.random() * influence;           // random mixer
    return rnd * (1 - mix) + bias * mix;           // mix full range and bias
  }

  function getRandomArbitrary(min, max) {
    return Math.round(Math.random() * (max - min) + min)
  }

</script>
</body>
</html>